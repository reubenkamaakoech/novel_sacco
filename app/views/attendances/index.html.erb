<% content_for :title, "Daily Attendance Record" %>

<div class="container">
  
<% if @attendances.blank? %>
  <p><i class="text-red">No attendance records found.</i></p>
<% else %>
  <p>Showing <%= @attendances.count %> attendance records.</p>
<% end %>

<%= link_to "New Attendance", new_attendance_path, class: "btn btn-success btn-sm" %>
<br/>
<br/>
<div class="attendance-list">
  
  <hr/>

  <div class="d-flex justify-content-between mb-3">
    <%= link_to "← Previous Week", request.params.merge(start_date: (@start_date - 7).to_s), class: "btn btn-outline-primary btn-sm" %>
    <span><%= @start_date.strftime("%d/%b/%Y") %> <strong>to</strong> <%= @end_date.strftime("%d/%b%Y") %></span>
    <%= link_to "Next Week →", request.params.merge(start_date: (@start_date + 7).to_s), class: "btn btn-outline-primary btn-sm" %>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead class="table-primary">
        <tr>
          <th>Date</th>
          <th>Site</th>
          <th>Employee</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>

       <% if @grouped_attendances.empty? %>
         <p><i class="text-red">No attendances found for the selected period.</i></p>
       <% end %>

        <% @grouped_attendances.each do |date, date_attendances| %>
  <tr>
    <td><%= date.strftime("%d-%b-%Y") %></td>
    <td colspan="3">
      <% date_attendances.group_by(&:site).each do |site, site_attendances| %>
        <strong><%= site&.name || "No Site" %></strong><br/>

        <% site_attendances.group_by(&:employee).each_with_index do |(employee, employee_attendances), index| %>
          <div>
            <%= index + 1 %>.
            <%= employee&.full_name || "No Employee" %> - Present
          </div>
        <% end %>

      <% end %>
    </td>
  </tr>
<% end %>

      </tbody>
    </table>
  </div>
</div>
<hr/>

<div class="d-flex justify-content-between mb-3 mt-4">
  <%= link_to "← Previous Week", request.params.merge(start_date: (@start_date - 7).to_s), class: "btn btn-outline-primary btn-sm" %>
  <span><%= @start_date.strftime("%d/%b/%Y") %> <strong>to</strong> <%= @end_date.strftime("%d/%b%Y") %></span>
  <%= link_to "Next Week →", request.params.merge(start_date: (@start_date + 7).to_s), class: "btn btn-outline-primary btn-sm" %>
</div>

  <div>
    <%= link_to "New Attendance", new_attendance_path, class: "btn btn-success btn-sm" %>
  </div>
</div>
<br/>
