<div class="container body_print">

  <% content_for :title, "Payroll" %>

<%= form_with url: payrolls_path, method: :get, local: true, class: "row g-3 mb-4" do %>
  <div class="col-auto d-print-none">
    <strong><%= label_tag :period, "Select Month" %></strong>
    <%= month_field_tag :period, @selected_period, class: "form-control", onchange: "this.form.submit();" %>
  </div>

  <div class="col-auto d-print-none">
    <strong><%= label_tag :half, "Select Period Range" %></strong>
    <% end_of_month_day = Date.parse(@selected_period + "-01").end_of_month.day.ordinalize rescue "end" %>
      <%= select_tag :half,
        options_for_select([
          ["Option 1 (1st–15th)", "1"],
          ["Option 2 (16th–#{end_of_month_day})", "2"]
        ], params[:half]),
        include_blank: "Full Month",
        class: "form-select",
        onchange: "this.form.submit();" %>
  </div>

  <div class="col-auto d-print-none">
    <strong><%= label_tag :employee_id, "Filter by Employee" %></strong>
    <%= select_tag :employee_id,
          options_from_collection_for_select(@employees, :id, :full_name, params[:employee_id]),
          include_blank: "All",
          class: "form-select",
          onchange: "this.form.submit();" %>
  </div>
<% end %>

 <% if @payrolls.empty? %>
  <p><i class="text-red">No payrolls found for:</i> <% if params[:half] == "1" %>
          1st to 15th, <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %>
         <% elsif params[:half] == "2" %>
          16th to <%= Date.parse(@selected_period + "-01").end_of_month.day.ordinalize %>, <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %>
         <% else %>
          Full Month of <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %>
         <% end %></p>
<% else %>

<h2>Payroll Summary for <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %></h2>

<% total_pay_sum = 0 %>
<% total_advances_sum = 0 %>
<% total_payable_sum = 0 %>

<table class="table table-bordered table-striped sticky-header">
  <thead class="table-primary style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;"">
    <tr>
      <th>Employee</th>
      <th>Phone Number</th>
      <th>National ID</th>
      <th class="d-print-none">Days Worked</th>
      <th class="d-print-none">Period</th>
      <th class="d-print-none">Daily Pay</th>
      <th class="d-print-none">Total Pay</th>
      <th class="d-print-none">Advance</th>
      <th>Payable</th>
    </tr>
  </thead>
  <tbody>
    <% @payrolls.each do |payroll| %>
      <% 
        # Setup date range
        start_date = Date.parse(@selected_period + "-01")
        mid_date = start_date + 14.days
        end_date = start_date.end_of_month

        date_range =
          case @half
          when "1"
            start_date..mid_date
          when "2"
            (mid_date + 1.day)..end_date
          else
            start_date..end_date
          end

        worked_days = payroll.employee.attendances
                       .where(work_date: date_range)
                       .where.not(site_id: nil)
                       .count

        daily_pay = payroll.daily_pay_at_time.to_f
        total_pay = worked_days * daily_pay
        advance = Advance.where(employee_id: payroll.employee_id, date: date_range).sum(:amount)
        payable = total_pay - advance

        total_pay_sum += total_pay
        total_advances_sum += advance
        total_payable_sum += payable
      %>
      <tr>
        <td><%= payroll.employee.full_name %></td>
        <td><%= payroll.employee.phone %></td>
         <td><%= payroll.employee.national_id %></td>
        <td class="text-center d-print-none"><%= worked_days %></td>
        <td class="d-print-none">
          <% if @half == "1" %>
            1st to 15th
          <% elsif @half == "2" %>
            16th to <%= Date.parse(@selected_period + "-01").end_of_month.day.ordinalize %>
          <% else %>
            Full Month
          <% end %>
        <td class="d-print-none"><%= number_to_currency(payroll.daily_pay_at_time, unit: "Ksh ") %></td>
        <td class="d-print-none"><%= number_to_currency(total_pay, unit: "Ksh ") %></td>
        <td class="d-print-none"><%= number_to_currency(advance, unit: "Ksh ") %></td>
        <td><%= number_to_currency(payable, unit: "Ksh ") %></td>
      </tr>
    <% end %>
  </tbody>
  <tfoot>
  <!-- Screen version -->
  <tr class="totals-row d-print-none">
    <th colspan="6">Totals</th>
    <th><%= number_to_currency(total_pay_sum, unit: "Ksh ") %></th>
    <th><%= number_to_currency(total_advances_sum, unit: "Ksh ") %></th>
    <th><%= number_to_currency(total_payable_sum, unit: "Ksh ") %></th>
  </tr>

  <!-- Print version -->
  <tr class="totals-row d-none d-print-table-row">
    <th colspan="3">Totals</th>

    <th><%= number_to_currency(total_payable_sum, unit: "Ksh ") %></th>
  </tr>
</tfoot>

</table>

<button id="toggle-summary" class="btn btn-primary btn-sm mb-2 d-print-none" style="margin-bottom: 10px;">Show Site Summary</button>

<div id="summary-table" style="display: none;">

<h3>Payroll Summary by Site</h3>

<table class="table table-bordered">
  <thead class="table-primary">
    <tr>
      <th rowspan="2">Site</th>
      <th colspan="3">
         <% if params[:half] == "1" %>
          1st to 15th, <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %>
         <% elsif params[:half] == "2" %>
          16th to <%= Date.parse(@selected_period + "-01").end_of_month.day.ordinalize %>, <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %>
         <% else %>
          Full Month of <%= Date.parse(@selected_period + "-01").strftime("%B %Y") %>
         <% end %>
      </th>
      <th colspan="3">All Time</th>
    </tr>
    <tr>
      <th>Employees</th>
      <th>Worked Days</th>
      <th>Total Pay</th>
      <th>Employees</th>
      <th>Worked Days</th>
      <th>Total Pay</th>
    </tr>
  </thead>
  <tbody>
    <% @site_summaries.each do |summary| %>
  <% current = summary[:current] %>
  <% unless current[:employees_count].to_i.zero? && current[:worked_days].to_i.zero? && current[:total_pay].to_f.zero? %>
    <tr>
      <td><%= summary[:site]&.name || "No Site" %></td>

      <!-- Current Month -->
      <td><%= current[:employees_count] %></td>
      <td><%= current[:worked_days] %></td>
      <td><%= number_to_currency(current[:total_pay], unit: "Ksh ") %></td>

      <!-- All Time -->
      <td><%= summary[:all_time][:employees_count] %></td>
      <td><%= summary[:all_time][:worked_days] %></td>
      <td><%= number_to_currency(summary[:all_time][:total_pay], unit: "Ksh ") %></td>
    </tr>
  <% end %>
<% end %>

  </tbody>
</table>
<% end %>
</div>
 

<script>
  document.addEventListener("turbo:load", function () {
    const button = document.getElementById("toggle-summary");
    const summary = document.getElementById("summary-table");

    if (button && summary) {
      button.addEventListener("click", function () {
        if (summary.style.display === "none") {
          summary.style.display = "block";
          button.textContent = "Hide Payroll Summary";
        } else {
          summary.style.display = "none";
          button.textContent = "Show Site Summary";
        }
      });
    }
  });
</script>

